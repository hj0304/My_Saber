{% extends 'core/base.html' %}

{% block content %}
<div class="space-y-8 animate-fade-in-up">
    
    <div class="text-center space-y-4">
        <h1 class="text-4xl font-bold text-gray-900 dark:text-white">ì„ ë°œ íˆ¬ìˆ˜ ê°€ì¹˜ í‰ê°€</h1>
        <p class="text-lg text-gray-600 dark:text-gray-400">
            ì´ë‹ ì†Œí™”(Inning Eating) vs ì‹¤ì  ì–µì œ(Run Suppression)<br>
            íŒ€ ìŠ¹ë¦¬ì— ë” ê¸°ì—¬í•˜ëŠ” íˆ¬ìˆ˜ëŠ” ëˆ„êµ¬ì¼ê¹Œìš”?
        </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        
        <div class="bg-white dark:bg-cardDark p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
            <h3 class="text-xl font-bold mb-4 text-blue-500">íˆ¬ìˆ˜ A (ì´ë‹ì´í„°)</h3>
            <div class="flex space-x-4">
                <div class="w-1/2">
                    <label class="block text-sm font-medium text-gray-500 mb-1">ì´ë‹ (IP)</label>
                    <select id="select-ip-a" class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700 border-none focus:ring-2 focus:ring-blue-500" onchange="updateChart()">
                        </select>
                </div>
                <div class="w-1/2">
                    <label class="block text-sm font-medium text-gray-500 mb-1">ì‹¤ì  (R)</label>
                    <select id="select-run-a" class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700 border-none focus:ring-2 focus:ring-blue-500" onchange="updateChart()">
                        </select>
                </div>
            </div>
            <div class="mt-4 text-center">
                <span class="text-sm text-gray-400">ì˜ˆìƒ ìŠ¹ë¥ </span>
                <div id="win-rate-a" class="text-4xl font-bold text-gray-900 dark:text-white">--%</div>
            </div>
        </div>

        <div class="bg-white dark:bg-cardDark p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
            <h3 class="text-xl font-bold mb-4 text-red-500">íˆ¬ìˆ˜ B (ì§ ë¬¼íˆ¬)</h3>
            <div class="flex space-x-4">
                <div class="w-1/2">
                    <label class="block text-sm font-medium text-gray-500 mb-1">ì´ë‹ (IP)</label>
                    <select id="select-ip-b" class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700 border-none focus:ring-2 focus:ring-red-500" onchange="updateChart()">
                        </select>
                </div>
                <div class="w-1/2">
                    <label class="block text-sm font-medium text-gray-500 mb-1">ì‹¤ì  (R)</label>
                    <select id="select-run-b" class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700 border-none focus:ring-2 focus:ring-red-500" onchange="updateChart()">
                        </select>
                </div>
            </div>
            <div class="mt-4 text-center">
                <span class="text-sm text-gray-400">ì˜ˆìƒ ìŠ¹ë¥ </span>
                <div id="win-rate-b" class="text-4xl font-bold text-gray-900 dark:text-white">--%</div>
            </div>
        </div>
    </div>

    <div class="bg-cardLight dark:bg-cardDark p-6 rounded-2xl shadow-sm">
        <h3 class="text-lg font-semibold mb-4 text-center">ìŠ¹ë¦¬ í™•ë¥  ë¹„êµ</h3>
        <div class="relative h-64 w-full">
            <canvas id="comparisonChart"></canvas>
        </div>
    </div>
    
    <div class="bg-blue-50 dark:bg-blue-900/20 p-6 rounded-xl text-sm text-blue-800 dark:text-blue-200">
        <strong>ğŸ’¡ Insight:</strong>
        <span id="insight-text">ë°ì´í„°ë¥¼ ì„ íƒí•˜ì—¬ ë¹„êµ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.</span>
    </div>
    
<div class="mt-12 bg-white dark:bg-cardDark p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
        <h3 class="text-xl font-bold mb-2">ìŠ¹ë¦¬ í™•ë¥  ë§¤íŠ¸ë¦­ìŠ¤ (Win Probability Matrix)</h3>
        <p class="text-sm text-gray-500 mb-6">
            ì„ ë°œ íˆ¬ìˆ˜ì˜ ì´ë‹ê³¼ ì‹¤ì ì— ë”°ë¥¸ íŒ€ì˜ ê¸°ëŒ€ ìŠ¹ë¥ ì…ë‹ˆë‹¤. (ë²”ìœ„: 3~9ì´ë‹, 0~7ì‹¤ì )
        </p>

        <div class="overflow-x-auto">
            <table class="w-full text-center border-collapse">
                <thead>
                    <tr>
                        <th class="p-2 text-sm text-gray-400 font-medium">IP \ Runs</th>
                        {% for i in "01234567" %}
                        <th class="p-2 text-sm font-semibold text-gray-700 dark:text-gray-300">{{ i }}ì </th>
                        {% endfor %}
                    </tr>
                </thead>
                
                <tbody>
                    {% for row in heatmap_rows %}
                    <tr>
                        <td class="p-2 font-bold text-gray-700 dark:text-gray-300 border-r dark:border-gray-700">
                            {{ row.ip }}ì´ë‹
                        </td>
                        
                        {% for col in row.cols %}
                        <td class="p-1">
                            {% if col.win_rate is not None %}
                            
                            <div class="rounded-lg py-2 px-1 transition hover:scale-105 cursor-default shadow-sm flex flex-col justify-center items-center"
                                 style="
                                        background-color: 
                                            {% if col.color_type == 'blue' %}
                                                rgba(59, 130, 246, {{ col.opacity }})
                                            {% else %}
                                                rgba(239, 68, 68, {{ col.opacity }})
                                            {% endif %};
                                        
                                        min-height: 52px;
                                 ">
                                     
                                <span class="text-sm font-bold leading-tight
                                            {% if col.opacity > 0.5 %}
                                                text-white
                                            {% else %}
                                                text-gray-900 dark:text-gray-100
                                            {% endif %}">
                                    {{ col.win_rate }}%
                                </span>
                                
                                <span class="text-[10px] leading-tight mt-0.5
                                            {% if col.opacity > 0.5 %}
                                                text-blue-100
                                            {% else %}
                                                text-gray-500 dark:text-gray-400
                                            {% endif %}">
                                    ({{ col.count }})
                                </span>
                            </div>

                            {% else %}
                            <div class="rounded-lg py-2 px-1 bg-gray-50 dark:bg-gray-800/50 text-gray-300 dark:text-gray-600 cursor-not-allowed border border-dashed border-gray-200 dark:border-gray-700 flex flex-col justify-center items-center"
                                 style="min-height: 52px;">
                                <span class="text-xs">
                                    N/A
                                </span>
                            </div>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>

            </table>
        </div>
        
        <div class="mt-4 flex justify-end items-center space-x-2 text-xs text-gray-500">
            <span>Low Win %</span>
            <div class="w-24 h-2 rounded-full bg-gradient-to-r from-white to-blue-500 border border-gray-200"></div>
            <span>High Win %</span>
        </div>
    </div>
</div>
<script>
    // 1. Djangoì—ì„œ ë³´ë‚¸ ë°ì´í„° ë°›ê¸°
    const matrixData = JSON.parse('{{ matrix_json|safe }}');
    
    // 2. ì´ˆê¸°í™” ë° í—¬í¼ í•¨ìˆ˜
    function getWinRate(ip, runs) {
        const data = matrixData.find(d => d.ip == ip && d.runs == runs);
        return data ? data.win_rate : 0;
    }

    // 3. ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ìƒì„± í•¨ìˆ˜
    function populateSelects() {
        const ips = [1,2,3,4,5,6,7,8,9];
        const runs = [0,1,2,3,4,5,6,7,8,9,10];
        
        // íˆ¬ìˆ˜ A, Bì˜ select ì—˜ë¦¬ë¨¼íŠ¸ë“¤
        const selectsIp = [document.getElementById('select-ip-a'), document.getElementById('select-ip-b')];
        const selectsRun = [document.getElementById('select-run-a'), document.getElementById('select-run-b')];
        
        selectsIp.forEach(sel => {
            ips.forEach(i => sel.innerHTML += `<option value="${i}">${i} ì´ë‹</option>`);
        });
        selectsRun.forEach(sel => {
            runs.forEach(r => sel.innerHTML += `<option value="${r}">${r} ì‹¤ì </option>`);
        });

        // ì´ˆê¸°ê°’ ì„¤ì • (9ì´ë‹ 3ì‹¤ì  vs 6ì´ë‹ ë¬´ì‹¤ì )
        document.getElementById('select-ip-a').value = 9;
        document.getElementById('select-run-a').value = 3;
        
        document.getElementById('select-ip-b').value = 6;
        document.getElementById('select-run-b').value = 0;
    }

    // 4. ì°¨íŠ¸ ì„¤ì •
    let myChart = null;
    
    function updateChart() {
        const ipA = document.getElementById('select-ip-a').value;
        const runA = document.getElementById('select-run-a').value;
        const ipB = document.getElementById('select-ip-b').value;
        const runB = document.getElementById('select-run-b').value;

        const winRateA = getWinRate(ipA, runA);
        const winRateB = getWinRate(ipB, runB);

        // í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        document.getElementById('win-rate-a').innerText = winRateA + '%';
        document.getElementById('win-rate-b').innerText = winRateB + '%';

        // ì¸ì‚¬ì´íŠ¸ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        const diff = (winRateA - winRateB).toFixed(1);
        const textElem = document.getElementById('insight-text');
        if (diff > 0) textElem.innerText = `íˆ¬ìˆ˜ Aê°€ íˆ¬ìˆ˜ Bë³´ë‹¤ ìŠ¹ë¦¬ í™•ë¥ ì´ ${diff}%p ë” ë†’ìŠµë‹ˆë‹¤. ì´ë‹ ì†Œí™” ëŠ¥ë ¥ì´ ë” ê³ í‰ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`;
        else if (diff < 0) textElem.innerText = `íˆ¬ìˆ˜ Bê°€ íˆ¬ìˆ˜ Aë³´ë‹¤ ìŠ¹ë¦¬ í™•ë¥ ì´ ${Math.abs(diff)}%p ë” ë†’ìŠµë‹ˆë‹¤. ì‹¤ì  ì–µì œê°€ ë” ì¤‘ìš”í•˜ê²Œ ì‘ìš©í–ˆìŠµë‹ˆë‹¤.`;
        else textElem.innerText = "ë‘ íˆ¬ìˆ˜ì˜ ê¸°ëŒ€ ìŠ¹ë¥ ì´ ë™ì¼í•©ë‹ˆë‹¤.";

        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        const ctx = document.getElementById('comparisonChart').getContext('2d');
        
        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['íˆ¬ìˆ˜ A', 'íˆ¬ìˆ˜ B'],
                datasets: [{
                    label: 'ê¸°ëŒ€ ìŠ¹ë¥  (%)',
                    data: [winRateA, winRateB],
                    backgroundColor: ['#3B82F6', '#EF4444'], // Blue, Red
                    borderRadius: 8,
                    barThickness: 50,
                }]
            },
            options: {
                indexAxis: 'y', // ê°€ë¡œ ë§‰ëŒ€ ê·¸ë˜í”„
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { beginAtZero: true, max: 100 }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    // ì‹¤í–‰
    populateSelects();
    updateChart();

</script>
{% endblock %}