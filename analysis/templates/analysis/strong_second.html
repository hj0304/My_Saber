{% extends 'core/base.html' %}

{% block content %}
<div class="space-y-8 animate-fade-in-up">
    
    <div class="text-center space-y-2">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">타순별 공격력 분석 (Strong 2nd)</h1>
        <p class="text-gray-600 dark:text-gray-400">
            팀별, 타순별 OPS 흐름과 해당 타순의 대표 선수를 분석합니다.
        </p>
    </div>

    <div class="bg-white dark:bg-cardDark p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
        <div class="flex flex-col md:flex-row gap-4 justify-between items-center">
            
            <div class="flex space-x-2">
                <button id="btn-mlb" class="px-5 py-2 rounded-lg font-bold transition text-sm shadow-md bg-primary text-white" onclick="setLeague('mlb')">MLB</button>
                <button id="btn-kbo" class="px-5 py-2 rounded-lg font-bold transition text-sm bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300" onclick="setLeague('kbo')">KBO</button>
            </div>

            <div class="flex space-x-4 w-full md:w-auto">
                <div class="w-1/3 md:w-auto">
                    <label class="block text-xs font-medium text-gray-500 mb-1">Year</label>
                    <select id="yearSelect" class="w-full md:w-32 p-2 rounded-lg bg-gray-100 dark:bg-gray-700 border-none outline-none focus:ring-2 focus:ring-primary dark:text-white font-bold"></select>
                </div>
                <div class="w-1/3 md:w-auto">
                    <label class="block text-xs font-medium text-gray-500 mb-1">Team</label>
                    <select id="teamSelect" class="w-full md:w-32 p-2 rounded-lg bg-gray-100 dark:bg-gray-700 border-none outline-none focus:ring-2 focus:ring-primary dark:text-white font-bold"></select>
                </div>
                <div class="w-1/3 md:w-auto">
                    <label class="block text-xs font-medium text-gray-500 mb-1">Order</label>
                    <select id="orderSelect" class="w-full md:w-32 p-2 rounded-lg bg-gray-100 dark:bg-gray-700 border-none outline-none focus:ring-2 focus:ring-primary dark:text-white font-bold">
                        {% for i in "123456789" %}
                            <option value="{{ i }}">{{ i }}번 타자</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="lg:col-span-2 bg-white dark:bg-cardDark p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
            <h3 class="text-xl font-bold mb-4 flex items-center">
                <span id="chartTitleTeam" class="text-primary mr-2">Team</span> 
                <span id="chartTitleOrder">2번 타자</span>
                <span class="text-gray-500 ml-2 font-normal text-base">vs League Avg OPS</span>
            </h3>
            <div class="relative h-80 w-full">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <div class="lg:col-span-1 bg-gradient-to-br from-blue-500 to-indigo-600 dark:from-gray-800 dark:to-black text-white p-6 rounded-2xl shadow-lg relative overflow-hidden flex flex-col justify-center">
            <div class="absolute top-0 right-0 -mr-10 -mt-10 w-40 h-40 bg-white opacity-10 rounded-full blur-3xl"></div>
            
            <h4 class="text-sm font-medium opacity-80 mb-6 uppercase tracking-wider">Most Frequent Player</h4>
            
            <div class="text-center space-y-4 z-10 relative">
                <div class="inline-block p-4 bg-white/20 rounded-full mb-2">
                    <span class="text-4xl">⚾️</span>
                </div>
                <div>
                    <h2 id="playerYear" class="text-lg font-light opacity-90">2024</h2>
                    <h1 id="playerName" class="text-3xl font-bold tracking-tight">Name</h1>
                    <p id="playerTeam" class="text-xl opacity-90 mt-1">Team Info</p>
                </div>
                
                <div class="grid grid-cols-3 gap-2 mt-6 pt-6 border-t border-white/20">
                    <div>
                        <span class="block text-xs opacity-60 uppercase">Player OPS</span>
                        <span id="playerOps" class="text-xl font-bold">0.000</span>
                    </div>
                    <div>
                        <span class="block text-xs opacity-60 uppercase text-yellow-300">Player wRC+</span>
                        <span id="playerWrc" class="text-xl font-bold text-yellow-300">0</span>
                    </div>
                    <div>
                        <span class="block text-xs opacity-60 uppercase">Player PA</span>
                        <span id="playerGames" class="text-xl font-bold">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const allData = {{ all_data|safe }};
    const years = {{ years|safe }};

    let currentLeague = 'mlb';
    let trendChart = null;

    const yearSelect = document.getElementById('yearSelect');
    const teamSelect = document.getElementById('teamSelect');
    const orderSelect = document.getElementById('orderSelect');

    // 연도 초기화
    years.forEach(y => {
        const option = document.createElement('option');
        option.value = y;
        option.text = y;
        yearSelect.appendChild(option);
    });
    yearSelect.value = years[years.length - 1];
    orderSelect.value = '2';

    function setLeague(league) {
        currentLeague = league;
        
        const btnMlb = document.getElementById('btn-mlb');
        const btnKbo = document.getElementById('btn-kbo');
        const activeClass = "bg-primary text-white shadow-md";
        const inactiveClass = "bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300";

        if (league === 'mlb') {
            btnMlb.className = `px-5 py-2 rounded-lg font-bold transition text-sm ${activeClass}`;
            btnKbo.className = `px-5 py-2 rounded-lg font-bold transition text-sm ${inactiveClass}`;
        } else {
            btnMlb.className = `px-5 py-2 rounded-lg font-bold transition text-sm ${inactiveClass}`;
            btnKbo.className = `px-5 py-2 rounded-lg font-bold transition text-sm ${activeClass}`;
        }

        populateTeams();
        updateDashboard();
    }

    function populateTeams() {
        const teamList = allData[currentLeague].team_list;
        teamSelect.innerHTML = '';
        teamList.forEach(t => {
            const option = document.createElement('option');
            option.value = t;
            option.text = t;
            teamSelect.appendChild(option);
        });
        if (teamList.length > 0) teamSelect.value = teamList[0];
    }

    function updateDashboard() {
        const selectedYear = yearSelect.value;
        const selectedTeam = teamSelect.value;
        const selectedOrder = orderSelect.value;
        
        const leagueDataObj = allData[currentLeague];
        const teamsData = leagueDataObj.teams_data;
        const avgData = leagueDataObj.avg_data;

        // --- A. 차트 업데이트 (Team Stats) ---
        // 팀 데이터 추출
        const teamOpsTrend = [];
        const teamMeta = []; // 툴팁용 메타데이터 (Team PA, Team wRC+)

        years.forEach(y => {
            const data = teamsData[selectedTeam]?.[y]?.[selectedOrder];
            if (data) {
                teamOpsTrend.push(data.team_ops);
                teamMeta.push({
                    year: y,
                    wrc: data.team_wrc,
                    pa: data.team_pa
                });
            } else {
                teamOpsTrend.push(null);
                teamMeta.push(null);
            }
        });

        // 리그 평균 데이터 추출
        const leagueOpsTrend = years.map(y => avgData[y]?.[selectedOrder]?.ops || null);

        document.getElementById('chartTitleTeam').innerText = selectedTeam;
        document.getElementById('chartTitleOrder').innerText = selectedOrder + '번 타자';

        const ctx = document.getElementById('trendChart').getContext('2d');
        if (trendChart) trendChart.destroy();

        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: years,
                datasets: [
                    {
                        label: `${selectedTeam} ${selectedOrder}번 타자 (Team OPS)`, 
                        data: teamOpsTrend,
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: `${currentLeague.toUpperCase()} Avg`, 
                        data: leagueOpsTrend,
                        borderColor: '#9CA3AF',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        tension: 0.3,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            // 툴팁에 팀 상세 정보 표시
                            afterBody: function(context) {
                                const teamTooltip = context.find(item => item.datasetIndex === 0); // 팀 데이터셋(첫번째)
                                if (teamTooltip) {
                                    const idx = teamTooltip.dataIndex;
                                    const meta = teamMeta[idx];
                                    if (meta) {
                                        return [
                                            `-----------------`,
                                            `Team PA: ${meta.pa}`,
                                            `Team wRC+: ${meta.wrc}`
                                        ];
                                    }
                                }
                                return [];
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        min: 0.400,
                        grid: { color: document.documentElement.classList.contains('dark') ? '#374151' : '#E5E7EB' }
                    },
                    x: { grid: { display: false } }
                }
            }
        });

        // --- B. 선수 카드 업데이트 (Player Stats) ---
        let playerData = teamsData[selectedTeam]?.[selectedYear]?.[selectedOrder];

        document.getElementById('playerYear').innerText = selectedYear;
        
        if (playerData) {
            // 선수 개인 성적 표시
            document.getElementById('playerName').innerText = playerData.player_name;
            document.getElementById('playerTeam').innerText = `${selectedTeam} #${selectedOrder}`;
            document.getElementById('playerOps').innerText = playerData.player_ops.toFixed(3); // 개인 OPS
            document.getElementById('playerWrc').innerText = playerData.player_wrc;           // 개인 wRC+
            document.getElementById('playerGames').innerText = playerData.player_pa;            // 개인 PA
        } else {
            document.getElementById('playerName').innerText = "-";
            document.getElementById('playerTeam').innerText = "No Data";
            document.getElementById('playerOps').innerText = "-";
            document.getElementById('playerWrc').innerText = "-";
            document.getElementById('playerGames').innerText = "-";
        }
    }

    yearSelect.addEventListener('change', updateDashboard);
    teamSelect.addEventListener('change', updateDashboard);
    orderSelect.addEventListener('change', updateDashboard);

    setLeague('mlb');
</script>
{% endblock %}