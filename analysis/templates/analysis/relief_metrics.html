{% extends 'core/base.html' %}

{% block content %}
<div class="space-y-8 animate-fade-in-up">
    
    <div class="text-center space-y-4">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Reliever Leaderboard</h1>
        <p id="pageDesc" class="text-gray-600 dark:text-gray-400">
            연도별 승리 기여도(WPA) 상위 10명의 불펜 투수를 분석합니다.
        </p>
    </div>

    <div class="bg-white dark:bg-cardDark p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col md:flex-row justify-between items-center gap-4">
        
        <div class="flex items-center space-x-4">
            <div class="flex space-x-2">
                <button id="btn-kbo" class="px-5 py-2 rounded-lg font-bold transition text-sm shadow-sm" onclick="setLeague('kbo')">
                    KBO
                </button>
                <button id="btn-mlb" class="px-5 py-2 rounded-lg font-bold transition text-sm" onclick="setLeague('mlb')">
                    MLB
                </button>
            </div>
        </div>

        <div class="flex flex-wrap justify-center items-center gap-4">
            
            <div class="flex items-center bg-gray-100 dark:bg-gray-800 rounded-lg p-1">
                <span class="text-xs font-bold text-gray-500 mx-2 uppercase">Sort by</span>
                <button id="btn-sort-wpa" class="px-3 py-1.5 rounded-md text-xs font-bold transition bg-white dark:bg-gray-600 shadow-sm text-primary" onclick="setSort('wpa')">
                    WPA
                </button>
                <button id="btn-sort-gmli" class="px-3 py-1.5 rounded-md text-xs font-bold transition text-gray-500 hover:text-gray-900 dark:text-gray-400" onclick="setSort('gmli')">
                    gmLI
                </button>
            </div>

            <div class="flex items-center space-x-2">
                <label class="text-sm font-medium text-gray-500">Year:</label>
                <select id="yearSelect" class="bg-gray-100 dark:bg-gray-700 border-none rounded-lg py-2 px-4 focus:ring-2 focus:ring-primary font-bold text-gray-900 dark:text-white" onchange="updateDashboard()">
                    </select>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <div class="bg-white dark:bg-cardDark p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
            <h3 id="chartTitle" class="text-lg font-bold mb-4 text-center">Top 10 Relievers Matrix</h3>
            <div class="relative h-96 w-full">
                <canvas id="reliefChart"></canvas>
            </div>
            <p class="mt-4 text-xs text-center text-gray-400">
                X축: gmLI (승부처 중요도) / Y축: WPA (승리 기여도)
            </p>
        </div>

        <div class="bg-white dark:bg-cardDark p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col h-[500px]">
            <h3 class="text-lg font-bold mb-4 flex justify-between shrink-0">
                <span id="tableTitle">Ranking (Top 10)</span>
                <span id="rankYearLabel" class="text-primary"></span>
            </h3>
            
            <div class="overflow-y-auto pr-2 custom-scrollbar">
                <table class="w-full text-left border-collapse">
                    <thead class="sticky top-0 bg-white dark:bg-cardDark z-10 shadow-sm">
                        <tr class="border-b dark:border-gray-600 text-xs uppercase text-gray-400">
                            <th class="py-2 px-2">Rank</th>
                            <th class="py-2 px-2">Player</th>
                            <th id="th-gmli" class="py-2 px-2 text-right cursor-pointer hover:text-primary transition" onclick="setSort('gmli')">gmLI</th>
                            <th id="th-wpa" class="py-2 px-2 text-right cursor-pointer hover:text-primary transition text-primary font-bold" onclick="setSort('wpa')">WPA</th>
                        </tr>
                    </thead>
                    <tbody id="rankingTableBody" class="text-sm">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
    // 1. Django 데이터 파싱
    const allData = JSON.parse('{{ all_data|safe }}');
    const kboYears = JSON.parse('{{ kbo_years|safe }}');
    const mlbYears = JSON.parse('{{ mlb_years|safe }}');
    
    // 상태 변수
    let currentLeague = 'kbo';
    let currentSort = 'wpa'; // 'wpa' or 'gmli'
    let reliefChart = null;
    
    const yearSelect = document.getElementById('yearSelect');

    // 2. 정렬 설정 함수 [추가됨]
    function setSort(sortMode) {
        currentSort = sortMode;
        updateSortUI();
        updateDashboard();
    }

    // 정렬 UI 업데이트 (버튼 및 테이블 헤더 스타일)
    function updateSortUI() {
        const btnWpa = document.getElementById('btn-sort-wpa');
        const btnGmli = document.getElementById('btn-sort-gmli');
        const thWpa = document.getElementById('th-wpa');
        const thGmli = document.getElementById('th-gmli');

        const activeBtnClass = "px-3 py-1.5 rounded-md text-xs font-bold transition bg-white dark:bg-gray-600 shadow-sm text-primary";
        const inactiveBtnClass = "px-3 py-1.5 rounded-md text-xs font-bold transition text-gray-500 hover:text-gray-900 dark:text-gray-400";

        if (currentSort === 'wpa') {
            btnWpa.className = activeBtnClass;
            btnGmli.className = inactiveBtnClass;
            
            // 테이블 헤더 강조
            thWpa.className = "py-2 px-2 text-right cursor-pointer text-primary font-bold";
            thGmli.className = "py-2 px-2 text-right cursor-pointer hover:text-primary transition";
        } else {
            btnWpa.className = inactiveBtnClass;
            btnGmli.className = activeBtnClass;

            // 테이블 헤더 강조
            thWpa.className = "py-2 px-2 text-right cursor-pointer hover:text-primary transition";
            thGmli.className = "py-2 px-2 text-right cursor-pointer text-primary font-bold";
        }
    }

    // 3. 리그 선택 함수
    function setLeague(league) {
        currentLeague = league;
        
        const btnKbo = document.getElementById('btn-kbo');
        const btnMlb = document.getElementById('btn-mlb');
        const activeClass = "bg-primary text-white shadow-md";
        const inactiveClass = "bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600";

        const pageDesc = document.getElementById('pageDesc');
        const chartTitle = document.getElementById('chartTitle');
        const tableTitle = document.getElementById('tableTitle');

        if (league === 'kbo') {
            btnKbo.className = `px-5 py-2 rounded-lg font-bold transition text-sm ${activeClass}`;
            btnMlb.className = `px-5 py-2 rounded-lg font-bold transition text-sm ${inactiveClass}`;
            
            pageDesc.innerText = "연도별 승리 기여도(WPA) 상위 10명의 불펜 투수를 분석합니다.";
            chartTitle.innerText = "Top 10 Relievers Matrix";
            tableTitle.innerText = "Ranking (Top 10)";
        } else {
            btnKbo.className = `px-5 py-2 rounded-lg font-bold transition text-sm ${inactiveClass}`;
            btnMlb.className = `px-5 py-2 rounded-lg font-bold transition text-sm ${activeClass}`;
            
            pageDesc.innerText = "연도별 승리 기여도(WPA) 상위 30명의 불펜 투수를 분석합니다.";
            chartTitle.innerText = "Top 30 Relievers Matrix";
            tableTitle.innerText = "Ranking (Top 30)";
        }

        updateYearOptions(league);
    }

    // 4. 연도 옵션 업데이트
    function updateYearOptions(league) {
        yearSelect.innerHTML = '';
        const years = (league === 'kbo') ? kboYears : mlbYears;
        
        if (!years || years.length === 0) {
            const opt = document.createElement('option');
            opt.text = "No Data";
            yearSelect.appendChild(opt);
            return;
        }

        years.forEach(y => {
            const opt = document.createElement('option');
            opt.value = y;
            opt.innerText = y;
            yearSelect.appendChild(opt);
        });

        yearSelect.value = years[years.length - 1];
        updateDashboard();
    }

    // 5. 대시보드 업데이트 (데이터 정렬 및 렌더링)
    function updateDashboard() {
        const selectedYear = yearSelect.value;
        document.getElementById('rankYearLabel').innerText = selectedYear;

        // 데이터 가져오기 (얕은 복사로 원본 보존)
        let topList = [];
        if (allData[currentLeague] && allData[currentLeague][selectedYear]) {
            topList = [...allData[currentLeague][selectedYear]];
        }

        // --- [핵심] 정렬 로직 적용 ---
        if (currentSort === 'wpa') {
            topList.sort((a, b) => b.wpa - a.wpa);
        } else if (currentSort === 'gmli') {
            topList.sort((a, b) => b.gmli - a.gmli);
        }

        // --- 차트 그리기 ---
        const ctx = document.getElementById('reliefChart').getContext('2d');
        if (reliefChart) reliefChart.destroy();

        reliefChart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Players',
                    data: topList.map(p => ({ x: p.gmli, y: p.wpa, player: p })),
                    backgroundColor: currentLeague === 'kbo' ? '#007AFF' : '#FF3B30', 
                    borderColor: '#fff',
                    borderWidth: 1,
                    pointRadius: 5,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.raw.player.name} (${ctx.raw.player.team}): WPA ${ctx.raw.player.wpa}, gmLI ${ctx.raw.player.gmli}`
                        }
                    }
                },
                scales: {
                    x: { 
                        title: { display: true, text: 'gmLI (Leverage)' },
                        suggestedMin: 0.5, suggestedMax: 2.5 
                    },
                    y: { 
                        title: { display: true, text: 'WPA' }
                    }
                }
            }
        });

        // --- 테이블 그리기 ---
        const tableBody = document.getElementById('rankingTableBody');
        tableBody.innerHTML = '';

        if (topList.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">데이터가 없습니다.</td></tr>';
            return;
        }

        topList.forEach((p, index) => {
            const tr = document.createElement('tr');
            tr.className = "border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition group";
            
            // 정렬 기준에 따라 텍스트 강조 (굵게 표시)
            const gmliClass = currentSort === 'gmli' ? "font-bold text-blue-600 dark:text-blue-400" : "text-gray-600 dark:text-gray-400";
            const wpaClass = currentSort === 'wpa' ? "font-bold text-blue-600 dark:text-blue-400" : "text-gray-600 dark:text-gray-400";

            tr.innerHTML = `
                <td class="py-3 px-2 font-bold text-gray-500 group-hover:text-primary transition">${index + 1}</td>
                <td class="py-3 px-2">
                    <div class="font-bold text-gray-800 dark:text-gray-200">${p.name}</div>
                    <div class="text-xs text-gray-400">${p.team}</div>
                </td>
                <td class="py-3 px-2 text-right font-mono ${gmliClass}">${p.gmli.toFixed(2)}</td>
                <td class="py-3 px-2 text-right font-mono ${wpaClass}">${p.wpa.toFixed(2)}</td>
            `;
            tableBody.appendChild(tr);
        });
    }

    // 초기화
    updateSortUI();
    setLeague('kbo');

</script>

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 20px;
    }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #475569;
    }
</style>
{% endblock %}