{% extends 'core/base.html' %}
{% load humanize %}
{% load static %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="space-y-10 animate-fade-in-up">
    
    <div class="text-center space-y-4">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">ê°€ì„±ë¹„ & ê°€ì¹˜ í‰ê°€ (Cost Effectiveness)</h1>
        <p class="text-gray-600 dark:text-gray-400">
            ì„ ìˆ˜ì˜ ì‹¤ì œ í™œì•½ ê°€ì¹˜(Dollars)ì™€ ì—°ë´‰ ëŒ€ë¹„ íš¨ìœ¨(Surplus)ì„ ë¶„ì„í•©ë‹ˆë‹¤.<br>
            <span class="text-xs text-gray-500">* ë°ì´í„° ì¶œì²˜: ì‹¤ì œ ì—°ë´‰ ë° WAR ë°ì´í„°</span>
        </p>
    </div>

    <div class="bg-white dark:bg-cardDark p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col md:flex-row justify-between items-center gap-4">
        <form id="filterForm" method="get" class="flex flex-col md:flex-row gap-4 w-full md:w-auto items-center">
            
            <div class="bg-gray-100 dark:bg-gray-700 p-1 rounded-lg flex">
                <button type="button" onclick="submitType('batter')" 
                    class="px-4 py-1.5 rounded-md text-sm font-bold transition {% if selected_type == 'batter' %}bg-white text-primary shadow-sm{% else %}text-gray-500 hover:text-gray-700 dark:text-gray-400{% endif %}">
                    íƒ€ì (Batter)
                </button>
                <button type="button" onclick="submitType('pitcher')" 
                    class="px-4 py-1.5 rounded-md text-sm font-bold transition {% if selected_type == 'pitcher' %}bg-white text-primary shadow-sm{% else %}text-gray-500 hover:text-gray-700 dark:text-gray-400{% endif %}">
                    íˆ¬ìˆ˜ (Pitcher)
                </button>
                <input type="hidden" name="type" id="typeInput" value="{{ selected_type }}">
            </div>

            <div class="flex items-center space-x-2">
                <label class="text-sm font-medium text-gray-500">Season:</label>
                <select name="year" onchange="this.form.submit()" 
                    class="bg-gray-50 dark:bg-gray-800 border-none rounded-lg py-2 pl-3 pr-8 focus:ring-2 focus:ring-primary font-bold text-gray-900 dark:text-white text-sm">
                    {% for y in years %}
                        <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>

    <div class="bg-white dark:bg-cardDark p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700">
        <div class="mb-6 flex justify-between items-end">
            <div>
                <h2 class="text-xl font-bold text-gray-900 dark:text-white">ğŸ’° Salary vs Real Value Correlation</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                    Xì¶•: ì—°ë´‰ (Salary) / Yì¶•: ì‹¤ì œ í™œì•½ ê°€ì¹˜ (Dollars Value)
                </p>
            </div>
        </div>
        <div class="relative h-96 w-full">
            <canvas id="scatterChart"></canvas>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <div class="bg-white dark:bg-cardDark p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700">
            <div class="mb-4 pb-2 border-b border-gray-100 dark:border-gray-700">
                <h2 class="text-lg font-bold text-blue-600 dark:text-blue-400 flex items-center">
                    <span class="mr-2">ğŸ†</span> Top 30 Value (Dollars)
                </h2>
                <p class="text-xs text-gray-400 mt-1">ìˆœìˆ˜í•˜ê²Œ ê°€ì¥ ë†’ì€ ê°€ì¹˜ë¥¼ ìƒì‚°í•œ ì„ ìˆ˜ë“¤</p>
            </div>
            
            <div class="overflow-x-auto max-h-[600px] overflow-y-auto custom-scrollbar">
                <table class="w-full text-left border-collapse">
                    <thead class="sticky top-0 bg-white dark:bg-cardDark z-10">
                        <tr class="text-xs uppercase text-gray-400 border-b dark:border-gray-600">
                            <th class="py-3 px-2 text-center">Rank</th>
                            <th class="py-3 px-2">Player</th>
                            <th class="py-3 px-2 text-right">WAR</th>
                            <th class="py-3 px-2 text-right">Dollars</th>
                        </tr>
                    </thead>
                    <tbody class="text-sm">
                        {% for player in top_dollars %}
                        <tr class="border-b border-gray-50 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800 transition group">
                            <td class="py-3 px-2 text-center">
                                {% if forloop.counter == 1 %}
                                    <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-yellow-400 text-white font-bold text-xs shadow-sm">1</span>
                                {% elif forloop.counter == 2 %}
                                    <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-gray-400 text-white font-bold text-xs shadow-sm">2</span>
                                {% elif forloop.counter == 3 %}
                                    <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-orange-400 text-white font-bold text-xs shadow-sm">3</span>
                                {% else %}
                                    <span class="text-gray-400 font-medium">{{ forloop.counter }}</span>
                                {% endif %}
                            </td>
                            <td class="py-3 px-2">
                                <div class="font-bold text-gray-800 dark:text-gray-200">{{ player.name }}</div>
                                <div class="text-xs text-gray-400">{{ player.team }}</div>
                            </td>
                            <td class="py-3 px-2 text-right font-bold text-gray-600 dark:text-gray-400">
                                {{ player.war|floatformat:1 }}
                            </td>
                            <td class="py-3 px-2 text-right">
                                <div class="font-bold text-blue-600 dark:text-blue-400">${{ player.dollars|intword }}</div>
                                <div class="w-full bg-gray-100 dark:bg-gray-700 rounded-full h-1.5 mt-1">
                                    <div class="bg-blue-500 h-1.5 rounded-full" style="width: {{ player.pct }}%"></div>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4" class="text-center py-10 text-gray-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="bg-white dark:bg-cardDark p-6 rounded-3xl shadow-sm border border-gray-100 dark:border-gray-700">
            <div class="mb-4 pb-2 border-b border-gray-100 dark:border-gray-700">
                <h2 class="text-lg font-bold text-green-600 dark:text-green-400 flex items-center">
                    <span class="mr-2">ğŸ“ˆ</span> Top 30 Efficiency (Surplus)
                </h2>
                <p class="text-xs text-gray-400 mt-1">ì—°ë´‰ ëŒ€ë¹„ ì´ˆê³¼ ê°€ì¹˜ë¥¼ ìƒì‚°í•œ 'í˜œì' ì„ ìˆ˜ë“¤</p>
            </div>

            <div class="overflow-x-auto max-h-[600px] overflow-y-auto custom-scrollbar">
                <table class="w-full text-left border-collapse">
                    <thead class="sticky top-0 bg-white dark:bg-cardDark z-10">
                        <tr class="text-xs uppercase text-gray-400 border-b dark:border-gray-600">
                            <th class="py-3 px-2 text-center">Rank</th>
                            <th class="py-3 px-2">Player</th>
                            <th class="py-3 px-2 text-right">Salary</th>
                            <th class="py-3 px-2 text-right">Surplus</th>
                        </tr>
                    </thead>
                    <tbody class="text-sm">
                        {% for player in top_surplus %}
                        <tr class="border-b border-gray-50 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800 transition group">
                            <td class="py-3 px-2 text-center">
                                <span class="text-gray-400 font-medium">{{ forloop.counter }}</span>
                            </td>
                            <td class="py-3 px-2">
                                <div class="font-bold text-gray-800 dark:text-gray-200">{{ player.name }}</div>
                                <div class="text-xs text-gray-400">{{ player.team }}</div>
                            </td>
                            <td class="py-3 px-2 text-right text-gray-500 text-xs">
                                ${{ player.salary|intword }}
                            </td>
                            <td class="py-3 px-2 text-right">
                                <div class="font-bold text-green-600 dark:text-green-400">+${{ player.surplus_value|intword }}</div>
                                <div class="w-full bg-gray-100 dark:bg-gray-700 rounded-full h-1.5 mt-1">
                                    <div class="bg-green-500 h-1.5 rounded-full" style="width: {{ player.pct }}%"></div>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4" class="text-center py-10 text-gray-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>

</div>

<script>
    // 1. íƒ€ì/íˆ¬ìˆ˜ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
    function submitType(type) {
        document.getElementById('typeInput').value = type;
        document.getElementById('filterForm').submit();
    }

    // 2. ì°¨íŠ¸ ë°ì´í„° íŒŒì‹±
    // Django í…œí”Œë¦¿ í•„í„° escapejsë¥¼ ì‚¬ìš©í•˜ì—¬ ì•ˆì „í•˜ê²Œ JSON ë¬¸ìì—´ë¡œ ë³€í™˜
    const rawData = JSON.parse('{{ scatter_data|escapejs }}');
    
    // Chart.js í˜•ì‹ì— ë§ê²Œ ë°ì´í„° ë§¤í•‘
    const chartData = rawData.map(item => ({
        x: item.x, 
        y: item.y, 
        name: item.name,
        team: item.team,
        surplus: item.surplus
    }));

    const ctx = document.getElementById('scatterChart').getContext('2d');

    // ë‹¤í¬ëª¨ë“œ ëŒ€ì‘ì„ ìœ„í•œ ì°¨íŠ¸ ìƒ‰ìƒ ì„¤ì •
    const isDark = document.documentElement.classList.contains('dark');
    const gridColor = isDark ? '#374151' : '#f3f4f6'; // dark:gray-700 or gray-100
    const textColor = isDark ? '#9ca3af' : '#6b7280'; // gray-400 or gray-500

    new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Players',
                data: chartData,
                backgroundColor: function(context) {
                    const val = context.raw;
                    if (!val) return '#3b82f6';
                    // Surplus > 0 (í˜œì): Green, < 0 (ë¨¹íŠ€): Red
                    return val.surplus > 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)';
                },
                borderColor: function(context) {
                    const val = context.raw;
                    if (!val) return '#3b82f6';
                    return val.surplus > 0 ? '#10b981' : '#ef4444';
                },
                borderWidth: 1,
                pointRadius: 6,
                pointHoverRadius: 9
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: isDark ? 'rgba(31, 41, 55, 0.9)' : 'rgba(255, 255, 255, 0.95)',
                    titleColor: isDark ? '#f3f4f6' : '#111827',
                    bodyColor: isDark ? '#d1d5db' : '#4b5563',
                    borderColor: isDark ? '#4b5563' : '#e5e7eb',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: false,
                    callbacks: {
                        label: function(context) {
                            const p = context.raw;
                            // í¬ë§·íŒ…
                            const salary = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumSignificantDigits: 3 }).format(p.x);
                            const value = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumSignificantDigits: 3 }).format(p.y);
                            return `${p.name} (${p.team}): Sal ${salary} / Val ${value}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Salary (AAV)', color: textColor, font: {weight: 'bold'} },
                    grid: { color: gridColor },
                    ticks: {
                        color: textColor,
                        callback: function(value) { return '$' + value / 1000000 + 'M'; }
                    }
                },
                y: {
                    title: { display: true, text: 'Real Value (Dollars)', color: textColor, font: {weight: 'bold'} },
                    grid: { color: gridColor },
                    ticks: {
                        color: textColor,
                        callback: function(value) { return '$' + value / 1000000 + 'M'; }
                    }
                }
            }
        }
    });
</script>

<style>
    /* í…Œì´ë¸” ë‚´ë¶€ ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ (Webkit) */
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: rgba(156, 163, 175, 0.5);
        border-radius: 20px;
    }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: rgba(75, 85, 99, 0.5);
    }
</style>
{% endblock %}